# STM32 28BYJ-48 스테퍼 모터 제어 시스템

## 개요
STM32F411RE 보드를 사용하여 서보모터와 28BYJ-48 스테퍼 모터를 제어하는 시스템입니다.

## 하드웨어 연결

### 서보모터
- **PWM 신호**: PA0 (TIM2_CH1)
- **전원**: 5V
- **GND**: 공통 그라운드

### 28BYJ-48 스테퍼 모터 (ULN2003 드라이버)
- **IN1**: PA4 (스테퍼 모터 코일 1)
- **IN2**: PA6 (스테퍼 모터 코일 2)
- **IN3**: PA7 (스테퍼 모터 코일 3)
- **IN4**: PA8 (스테퍼 모터 코일 4)
- **전원**: 5V (모터용), 5V (드라이버용)
- **GND**: 공통 그라운드

### 버튼
- **BNT1**: PC0 (서보모터 0도)
- **BNT2**: PC1 (서보모터 90도)
- **B1**: PC13 (리셋 버튼)

### UART
- **TX**: PA2
- **RX**: PA3
- **보드레이트**: 115200

## 28BYJ-48 스테퍼 모터 특징

### 기본 사양
- **전압**: 5V 또는 12V
- **스텝 수**: 2048 스텝 (하프 스텝 모드)
- **스텝 각도**: 0.175도 (하프 스텝)
- **감속비**: 1:64
- **토크**: 약 0.3 Nm

### ULN2003 드라이버
- **입력 전압**: 5V
- **출력 전압**: 모터 전압에 따라
- **최대 전류**: 500mA per channel
- **4채널 트랜지스터 배열**

## 사용법

### 1. 시리얼 통신 연결
- 터미널 프로그램 (PuTTY, Tera Term 등) 사용
- 보드레이트: 115200
- 데이터 비트: 8
- 정지 비트: 1
- 패리티: None

### 2. 메뉴 시스템
시스템 시작 시 다음과 같은 메뉴가 표시됩니다:

```
=== STM32 모터 제어 시스템 ===

=== 메뉴 선택 ===
1. 서보모터 회전
2. 스텝모터 회전
선택하세요 (1 또는 2):
```

### 3. 서보모터 제어
- 메뉴에서 '1' 선택
- 버튼을 눌러 각도 변경:
  - BNT1: 0도 (1ms 펄스)
  - BNT2: 90도 (1.75ms 펄스)
- 'm' 입력으로 메인 메뉴로 돌아가기

### 4. 28BYJ-48 스테퍼 모터 제어
- 메뉴에서 '2' 선택
- 현재 위치가 표시됩니다
- 목표 각도를 입력 (0-100, 100=한바퀴)
- 엔터키로 실행
- 이동 완료 후 다시 회전할지 선택

#### 스테퍼 모터 사용 예시:
1. 처음 시작 시 위치: 0도
2. 50 입력 → 반바퀴 회전 (현재 위치: 50도)
3. 100 입력 → 또 반바퀴 회전 (현재 위치: 100도)
4. 0 입력 → 한바퀴 역회전 (현재 위치: 0도)

## 28BYJ-48 스테퍼 모터 설정

### 기본 설정
- **스텝 수**: 2048 (하프 스텝 모드)
- **최대 각도**: 100 (100 = 한바퀴)
- **스텝 지연**: 2ms

### 설정 변경
`main.h` 파일에서 다음 값들을 수정할 수 있습니다:

```c
#define STEPS_PER_REVOLUTION 2048  // 28BYJ-48 하프 스텝 모드
#define MAX_ANGLE 100              // 최대 각도 (100 = 한바퀴)
#define STEP_DELAY_MS 2            // 스텝 간 지연시간 (밀리초)
```

### 4상 제어 시퀀스
28BYJ-48은 4상 스테퍼 모터로 다음과 같은 시퀀스로 제어됩니다:

```
스텝 0: IN1=1, IN2=0, IN3=0, IN4=0
스텝 1: IN1=1, IN2=1, IN3=0, IN4=0
스텝 2: IN1=0, IN2=1, IN3=0, IN4=0
스텝 3: IN1=0, IN2=1, IN3=1, IN4=0
스텝 4: IN1=0, IN2=0, IN3=1, IN4=0
스텝 5: IN1=0, IN2=0, IN3=1, IN4=1
스텝 6: IN1=0, IN2=0, IN3=0, IN4=1
스텝 7: IN1=1, IN2=0, IN3=0, IN4=1
```

## 빌드 및 플래시

### STM32CubeIDE 사용
1. 프로젝트 열기
2. 프로젝트 빌드 (Ctrl+B)
3. 플래시 및 디버그 실행 (F11)

### 명령줄 사용
```bash
# 프로젝트 디렉토리로 이동
cd C:\workspace_jinwoo\STM32\Timer\servo2

# 빌드
make

# 플래시 (ST-Link 사용)
st-flash write build/servo2.bin 0x8000000
```

## 문제 해결

### 28BYJ-48 스테퍼 모터가 움직이지 않는 경우
1. 전원 연결 확인 (5V 모터용, 5V 드라이버용)
2. IN1~IN4 핀 연결 확인 (PA4, PA6, PA7, PA8)
3. ULN2003 드라이버 연결 확인
4. 스텝 지연시간 조정 (STEP_DELAY_MS 값 변경)

### 스테퍼 모터가 거꾸로 회전하는 경우
- 코드에서 방향을 반대로 설정하거나
- 하드웨어 연결을 변경

### 스테퍼 모터가 부드럽게 움직이지 않는 경우
- STEP_DELAY_MS 값을 조정 (1~5ms 권장)
- 전원 공급 확인

### 서보모터가 움직이지 않는 경우
1. PWM 신호 확인 (PA0 핀)
2. 전원 연결 확인 (5V)
3. PWM 주파수 확인 (50Hz)

### 시리얼 통신이 안 되는 경우
1. 보드레이트 확인 (115200)
2. TX, RX 핀 연결 확인
3. 터미널 프로그램 설정 확인

## 주의사항
- 28BYJ-48은 5V 전원을 사용하므로 적절한 전원 공급장치를 사용하세요
- ULN2003 드라이버는 모터 전류를 제한하므로 과부하를 피하세요
- 스테퍼 모터는 연속 회전 시 발열이 발생할 수 있으므로 주의하세요
- 서보모터는 PWM 신호가 필요하므로 타이머 설정을 확인하세요

## 성능 최적화
- 스텝 지연시간을 조정하여 속도와 정확도 균형 맞추기
- 전원 공급을 안정적으로 유지하기
- 모터 부하에 따른 토크 확인하기
