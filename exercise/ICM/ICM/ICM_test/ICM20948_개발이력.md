# ICM20948 프로젝트 개발 이력

STM32CubeIDE 1.18.1, STM32F411RE + ICM20948 9축 IMU (가속도/자이로/마그) 드라이버 및 필터 적용 기록입니다.

---

## 1. 전체 요약

| 단계 | 내용 | 수정한 파일 | 변경 횟수(대략) |
|------|------|-------------|-----------------|
| 1 | ICM20948 드라이버 신규 작성 (가속도/자이로/마그) | `icm20948.h` 신규, `icm20948.c` 신규, `main.c` | 1회 |
| 2 | I2C 주소 0x68/0x69 자동 시도 (LD2 깜빡임 해결) | `icm20948.h`, `icm20948.c` | 1회 |
| 3 | 1차 EMA 필터 추가 | `icm20948.h`, `icm20948.c`, `main.c` | 1회 |
| 4 | 2단계 캐스케이드 EMA 필터 추가 | `icm20948.h`, `icm20948.c`, `main.c` | 1회 |
| 5 | 이동평균(MA) 필터 추가, 필터 모드 선택 | `icm20948.h`, `icm20948.c`, `main.c` | 1회 |
| 6 | 코드 설명 주석 및 이력 문서 작성 | `icm20948.h`, `icm20948.c`, `main.c`, 본 문서 | 1회 |

- **핀 설정**: CubeMX 기준 **PB6(SCL), PB7(SDA)** 사용. 코드에서 핀 설정 변경한 적 없음.
- **main.c USER CODE**: 초기화/루프에서 ICM20948 사용 구간만 수정. 수정 횟수는 위 표와 동일.

---

## 2. 파일별 변경 요약

### 2.1 Core/Inc/icm20948.h
- **신규 생성** 후 계속 확장.
- 변경 이력: 레지스터/상수 정의 → 필터 구조체(EMA) → 필터 모드(EMA/MA), MA용 버퍼/상태 추가 → 주석 정리.
- **수정 횟수**: 약 5~6회 (신규 1 + 필터 관련 4 + 주석 1).

### 2.2 Core/Src/icm20948.c
- **신규 생성** 후 계속 확장.
- 변경 이력: Init/Read Accel·Gyro·Mag → I2C 주소 이중 시도 → 1차 EMA → 2단 EMA → MA 필터 및 모드 분기 → 주석 정리.
- **수정 횟수**: 약 6~7회.

### 2.3 Core/Src/main.c
- **USER CODE만** 수정 (Includes, PV, Init 후 센서 초기화·필터 설정, while 루프 안 ReadAll·UART 출력).
- 변경 이력: ICM20948 초기화 + 실패 시 LD2 깜빡임 → EMA 필터 설정 → 2단 EMA → MA(윈도우 10)로 변경 → 주석 추가.
- **수정 횟수**: 약 4~5회.

### 2.4 Core/Src/stm32f4xx_hal_msp.c, ICM_test.ioc
- **수정 없음**. I2C는 처음부터 PB6/PB7로 설정된 상태 유지.

---

## 3. 현재 동작 요약

1. **초기화**: I2C 0x68 → 실패 시 0x69 시도, WHO_AM_I 확인 후 ICM20948·AK09916(마그) 설정.
2. **필터**: 기본은 **이동평균(MA, 윈도우 10)**. `ICM20948_SetFilter()` 호출 시 **2단 EMA** 모드로 전환 가능.
3. **루프**: 200ms마다 가속도/자이로/마그 읽기 → (필터 적용된) 물리값 + raw를 UART 115200으로 출력.

---

## 4. 필터 API 요약

```c
// 2단 EMA (alpha 작을수록 부드러움)
ICM20948_SetFilter(&hicm20948, 1, 0.2f);

// 이동평균 (윈도우 4~16, 고정 시 노이즈 감소에 유리)
ICM20948_SetFilterMovingAvg(&hicm20948, 1, 10);

// 필터 상태 초기화
ICM20948_ResetFilter(&hicm20948);
```

자세한 설명은 각 소스 파일 상단·섹션 주석을 참고하면 됩니다.

---

## 5. 필터 제외 — 센서만 구현 요약

필터(EMA/MA) 없이 **ICM20948 인식 + 가속도/자이로/마그 읽기**만 어떻게 구현했는지 정리.

### 5.1 전체 흐름

- **I2C**로 ICM20948 레지스터 읽/쓰기.
- ICM20948은 **뱅크 0~3**으로 레지스터가 나뉘어 있음 → 읽기 전에 **뱅크 선택(0x7F에 값 기록)**.
- **마그(AK09916)**는 ICM20948 **내부 I2C 마스터**로만 접근 → Bank3에서 SLV0 설정 후, Bank0의 `EXT_SLV_SENS_DATA_00`에서 데이터 읽기.

### 5.2 초기화 (Init)

1. **I2C 주소**  
   - 먼저 **0x68**로 뱅크0 선택 시도 → 실패하면 **0x69**로 한 번 더 시도 (AD0 핀에 따라 주소가 달라짐).

2. **WHO_AM_I**  
   - Bank0 레지스터 **0x00** 읽어서 **0xEA**인지 확인. 아니면 해당 주소로는 실패.

3. **리셋 & 클럭**  
   - **PWR_MGMT_1(0x06)**에 `0x80` 넣어 리셋 → 잠시 대기.  
   - 다시 **PWR_MGMT_1**에 `0x01` (PLL 클럭 선택) 넣어 동작 모드로.

4. **축 켜기**  
   - **PWR_MGMT_2(0x07)**에 `0x00` → 가속도·자이로 축 전부 활성화.

5. **가속도/자이로 스케일 (Bank2)**  
   - **0x7F**에 Bank2 선택값(`0x20`) 기록.  
   - **GYRO_CONFIG_1(0x01)**에 `0x01` → 자이로 **±500 dps**.  
   - **ACCEL_CONFIG(0x14)**에 `0x01` → 가속도 **±4g**.  
   - 다시 **0x7F**에 Bank0 선택값(`0x00`) 넣어 Bank0으로 복귀.

6. **마그(AK09916)용 I2C 마스터**  
   - Bank0 **USER_CTRL(0x03)**에 `I2C_MST_EN` 비트 세팅 → I2C 마스터 활성화.  
   - Bank3 선택 후:  
     - **I2C_MST_CTRL(0x01)**로 마스터 클럭 설정.  
     - **SLV0**로 AK09916에 **쓰기**:  
       - CNTL3(0x32)에 0x01 → 소프트 리셋.  
       - CNTL2(0x31)에 0x08 → 연속 측정 모드(100Hz).  
   - 다시 Bank0으로 복귀.

정리하면: **주소 시도 → WHO_AM_I → 리셋/클럭/축 켜기 → Bank2에서 스케일 설정 → Bank3에서 I2C 마스터·AK09916 초기화 → Bank0 복귀**까지가 “필터 제외한 Init” 구현.

### 5.3 가속도 읽기

- Bank0 선택 후, 레지스터 **0x2D**부터 **6바이트** 읽기 (XH,XL, YH,YL, ZH,ZL).  
- 2바이트씩 묶어 **int16_t**로 만들고, **8192.0f (4g 스케일)**로 나누면 **g 단위**.  
- (필터 제외하면 여기서 나온 g 값을 그대로 사용.)

### 5.4 자이로 읽기

- Bank0 선택 후, 레지스터 **0x33**부터 **6바이트** 읽기.  
- 마찬가지로 int16_t로 만든 뒤 **65.5f (500dps 스케일)**로 나누면 **dps 단위**.  
- (필터 제외하면 이 값 그대로 사용.)

### 5.5 마그 읽기 (AK09916)

- 마그는 ICM20948 **내부 I2C**로만 접근하므로, **ICM20948이 대신 읽어준 결과**를 받는 방식.

1. **Bank3** 선택.  
2. **SLV0** 설정:  
   - 슬레이브 주소 **0x0C | 0x80** (AK09916 읽기).  
   - 시작 레지스터 **0x10** (AK09916 ST1).  
   - **8바이트** 읽기, SLV0 활성화.  
3. **Bank0**으로 돌아온 뒤, **2ms 정도 대기** (I2C 마스터가 읽을 시간).  
4. Bank0 **EXT_SLV_SENS_DATA_00(0x3B)**부터 **8바이트** 읽기.  
   - 배열 인덱스 1–2: HX, 3–4: HY, 5–6: HZ (각각 L/H 바이트).  
5. 16비트로 묶어서 **0.15f** 곱하면 **µT 단위**.

즉, “필터 제외”면 위 1~5 단계로 구한 **g / dps / µT**가 그대로 최종 출력.

### 5.6 한 줄 요약 표

| 항목 | 내용 |
|------|------|
| **통신** | I2C, 7비트 주소 0x68 또는 0x69 (Init에서 둘 다 시도) |
| **뱅크** | 레지스터 접근 전마다 0x7F에 뱅크 값 기록 (0=Bank0, 0x20=Bank2, 0x30=Bank3) |
| **Init** | 주소 시도 → WHO_AM_I(0xEA) → 리셋·PLL·축 활성화 → Bank2에서 자이로 500dps/가속도 4g → I2C 마스터 켜고 Bank3에서 AK09916 리셋·연속모드 → Bank0 복귀 |
| **가속도** | Bank0, 0x2D~0x32 6바이트 → int16 → /8192 → g |
| **자이로** | Bank0, 0x33~0x38 6바이트 → int16 → /65.5 → dps |
| **마그** | Bank3에서 SLV0로 AK09916 0x10부터 8바이트 읽기 설정 → Bank0 0x3B에서 8바이트 읽어 HX,HY,HZ 추출 → ×0.15 → µT |
